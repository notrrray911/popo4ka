{% extends "base.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –¥–ª—è —Ö–æ–±–±–∏{% endblock %}

{% block content %}
<div class="generate-page">
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π</h1>
    <p class="page-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–ª—É—á–∞–π–Ω—É—é –∏–¥–µ—é –¥–ª—è —Ö–æ–±–±–∏</p>

    <div class="generate-container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-section">
            <div class="filters-card">
                <div class="filters-header">
                    <h3><i class="fas fa-sliders-h"></i> –§–∏–ª—å—Ç—Ä—ã</h3>
                    <p class="filters-subtitle">–ü–æ–¥–±–µ—Ä–∏—Ç–µ —Ö–æ–±–±–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –±—é–¥–∂–µ—Ç—É –∏ –º–µ—Å—Ç—É</p>
                </div>

                <form id="filters-form" method="POST" action="{{ url_for('generate_idea') }}">
                    <div class="form-group">
                        <label for="time"><i class="fas fa-clock"></i> –í—Ä–µ–º—è</label>
                        <select id="time" name="time" class="form-control">
                            <option value="">–õ—é–±–æ–µ –≤—Ä–µ–º—è</option>
                            <option value="short" {% if filters.time == 'short' %}selected{% endif %}>–î–æ 1 —á–∞—Å–∞</option>
                            <option value="medium" {% if filters.time == 'medium' %}selected{% endif %}>1-3 —á–∞—Å–∞</option>
                            <option value="long" {% if filters.time == 'long' %}selected{% endif %}>–ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="budget"><i class="fas fa-wallet"></i> –ë—é–¥–∂–µ—Ç</label>
                        <select id="budget" name="budget" class="form-control">
                            <option value="">–õ—é–±–æ–π –±—é–¥–∂–µ—Ç</option>
                            <option value="free" {% if filters.budget == 'free' %}selected{% endif %}>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
                            <option value="low" {% if filters.budget == 'low' %}selected{% endif %}>–ù–∏–∑–∫–∏–π (–¥–æ 500 —Ä—É–±)</option>
                            <option value="medium" {% if filters.budget == 'medium' %}selected{% endif %}>–°—Ä–µ–¥–Ω–∏–π (500-2000 —Ä—É–±)</option>
                            <option value="high" {% if filters.budget == 'high' %}selected{% endif %}>–í—ã—Å–æ–∫–∏–π (–±–æ–ª–µ–µ 2000 —Ä—É–±)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="location"><i class="fas fa-map-marker-alt"></i> –ú–µ—Å—Ç–æ</label>
                        <select id="location" name="location" class="form-control">
                            <option value="">–õ—é–±–æ–µ –º–µ—Å—Ç–æ</option>
                            <option value="indoor" {% if filters.location == 'indoor' %}selected{% endif %}>–î–æ–º–∞</option>
                            <option value="outdoor" {% if filters.location == 'outdoor' %}selected{% endif %}>–ù–∞ —É–ª–∏—Ü–µ</option>
                            <option value="both" {% if filters.location == 'both' %}selected{% endif %}>–ù–µ –≤–∞–∂–Ω–æ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category"><i class="fas fa-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="category" name="category" class="form-control">
                            <option value="">–õ—é–±–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {% if filters.category == category %}selected{% endif %}>{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty"><i class="fas fa-signal"></i> –°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                        <select id="difficulty" name="difficulty" class="form-control">
                            <option value="">–õ—é–±–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                            <option value="easy" {% if filters.difficulty == 'easy' %}selected{% endif %}>–õ–µ–≥–∫–∞—è</option>
                            <option value="medium" {% if filters.difficulty == 'medium' %}selected{% endif %}>–°—Ä–µ–¥–Ω—è—è</option>
                            <option value="hard" {% if filters.difficulty == 'hard' %}selected{% endif %}>–°–ª–æ–∂–Ω–∞—è</option>
                        </select>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn-primary btn-block">
                            <i class="fas fa-random"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ—é
                        </button>
                        <button type="button" id="random-btn" class="btn-secondary btn-block">
                            <i class="fas fa-dice"></i> –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª—É—á–∞–π–Ω–æ
                        </button>
                        <button type="button" id="reset-btn" class="btn-action btn-block">
                            <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="result-section">
            <div class="result-card">
                <div class="result-header">
                    <h3><i class="fas fa-lightbulb"></i> –°–ª—É—á–∞–π–Ω–∞—è –∏–¥–µ—è</h3>
                    {% if idea %}
                    <div class="result-actions">
                        <button onclick="shareIdea()" class="btn-action small">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button onclick="saveAsImage()" class="btn-action small">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>

                {% if idea %}
                <div class="idea-result" id="idea-result">
                    <div class="idea-header">
                        <span class="idea-category">{{ idea.category }}</span>
                        <div class="idea-votes">
                            <i class="fas fa-heart"></i> {{ idea.votes }}
                        </div>
                    </div>

                    <h2 class="idea-title">{{ idea.title }}</h2>

                    <div class="idea-meta">
                        <span class="meta-item">
                            <i class="fas fa-clock"></i>
                            {% if idea.time_required == 'short' %}–î–æ 1 —á–∞—Å–∞
                            {% elif idea.time_required == 'medium' %}1-3 —á–∞—Å–∞
                            {% elif idea.time_required == 'long' %}–ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤
                            {% endif %}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-wallet"></i>
                            {% if idea.budget == 'free' %}–ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                            {% elif idea.budget == 'low' %}–ù–∏–∑–∫–∏–π
                            {% elif idea.budget == 'medium' %}–°—Ä–µ–¥–Ω–∏–π
                            {% elif idea.budget == 'high' %}–í—ã—Å–æ–∫–∏–π
                            {% endif %}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            {% if idea.location == 'indoor' %}–î–æ–º–∞
                            {% elif idea.location == 'outdoor' %}–ù–∞ —É–ª–∏—Ü–µ
                            {% elif idea.location == 'both' %}–õ—é–±–æ–µ
                            {% endif %}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-signal"></i>
                            {% if idea.difficulty == 'easy' %}–õ–µ–≥–∫–∞—è
                            {% elif idea.difficulty == 'medium' %}–°—Ä–µ–¥–Ω—è—è
                            {% elif idea.difficulty == 'hard' %}–°–ª–æ–∂–Ω–∞—è
                            {% endif %}
                        </span>
                    </div>

                    <div class="idea-description">
                        <p>{{ idea.description }}</p>
                    </div>

                    <div class="idea-actions">
                        <button onclick="voteIdea({{ idea.id }})" class="btn-action">
                            <i class="fas fa-thumbs-up"></i> –ù—Ä–∞–≤–∏—Ç—Å—è
                        </button>
                        <button onclick="addToMyIdeas({{ idea.id }})" class="btn-action">
                            <i class="fas fa-bookmark"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button onclick="generateNew()" class="btn-action">
                            <i class="fas fa-redo"></i> –î—Ä—É–≥–∞—è –∏–¥–µ—è
                        </button>
                    </div>

                    <div class="idea-footer">
                        <small><i class="fas fa-calendar"></i> –î–æ–±–∞–≤–ª–µ–Ω–æ: {{ idea.created_at }}</small>
                    </div>
                </div>

                {% elif not has_ideas %}
                <div class="no-ideas">
                    <div class="no-ideas-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>–ù–µ—Ç –∏–¥–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
                    <button onclick="resetFilters()" class="btn-secondary">
                        <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>

                {% else %}
                <div class="waiting-for-idea">
                    <div class="waiting-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ—é"</h3>
                    <p>–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª—É—á–∞–π–Ω–æ" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—é–±–æ–π –∏–¥–µ–∏</p>
                    <div class="tips">
                        <p><strong>–°–æ–≤–µ—Ç:</strong> –ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</p>
                    </div>
                </div>
                {% endif %}
            </div>

            {% if idea %}
            <div class="quick-actions">
                <h4><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
                <div class="quick-buttons">
                    <a href="{{ url_for('add_idea') }}" class="btn-action small">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ö–æ–∂—É—é
                    </a>
                    <a href="{{ url_for('challenge') }}" class="btn-action small">
                        <i class="fas fa-trophy"></i> –°–¥–µ–ª–∞—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª—É—á–∞–π–Ω–æ"
    document.getElementById('random-btn').addEventListener('click', function() {
        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('filters-form').reset();
        document.getElementById('filters-form').submit();
    });

    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('reset-btn').addEventListener('click', function() {
        document.getElementById('filters-form').reset();
    });

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetFilters() {
        document.getElementById('filters-form').reset();
        document.getElementById('filters-form').submit();
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–¥–µ–∏ —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    function generateNew() {
        document.getElementById('filters-form').submit();
    }

    // –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏–¥–µ—é
    function voteIdea(ideaId) {
        fetch(`/vote/${ideaId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≥–æ–ª–æ—Å! ‚ù§Ô∏è', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    const votesElement = document.querySelector('.idea-votes');
                    if (votesElement) {
                        votesElement.innerHTML = `<i class="fas fa-heart"></i> ${data.votes}`;
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ "–ú–æ–∏ –∏–¥–µ–∏"
    function addToMyIdeas(ideaId) {
        fetch(`/add_to_my_ideas/${ideaId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, data.success ? 'success' : 'info');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            });
    }

    // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–¥–µ–µ–π
    function shareIdea() {
        const ideaTitle = document.querySelector('.idea-title').textContent;
        const text = `–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç—É –∏–¥–µ—é –¥–ª—è —Ö–æ–±–±–∏: "${ideaTitle}"`;

        if (navigator.share) {
            navigator.share({
                title: '–ò–¥–µ—è –¥–ª—è —Ö–æ–±–±–∏',
                text: text,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(text + '\n' + window.location.href).then(() => {
                showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞! üìã', 'success');
            });
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∑–∞–≥–ª—É—à–∫–∞)
    function saveAsImage() {
        showToast('–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üì∏', 'info');
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    // –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.querySelectorAll('.form-control').forEach(select => {
        select.addEventListener('change', function() {
            this.style.borderColor = 'var(--primary-color)';
            this.style.boxShadow = '0 0 0 2px rgba(138, 43, 226, 0.1)';
        });
    });
</script>
{% endblock %}